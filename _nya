# _nya は NYAOS の初期設定ファイルです.
#   (1) NYAOS.EXE のあるディレクトリ
#   (2) %HOME% の下(未定義であれば %USERPROFILE%)
#   (3) カレントディレクトリ
# にある _nya を「順に全て」呼び出します.
# ※ ただし、(1)==(3) の場合等は、(3)を呼び出しません.
#
# 通常
#    - NYAOS.EXE に添付の _nya (当ファイル) は (1) へ
#    - そのユーザで定義する設定は (2) へ
# 配置してください.

echo %0 reading ...

suffix ny  %nyatype% -f
suffix pl  perl
suffix py  python
suffix rb  ruby
suffix jar java -jar
suffix lua lua
suffix awk awk -f
suffix vbs cscript
suffix js  cscript
suffix cmd %COMSPEC% /c
suffix bat %COMSPEC% /c

option uncompletechar ,;=
option tilde   on
option history on
option backquote  4000
option +keep_bottom_line
option prompt $e[31;40;1m[$w]$_$$ $e[37;1m

foreach i (dir mkdir rmdir copy move rename ren type md rd start del echo)
    alias $i $COMSPEC /c $i
end
alias dir\w %COMSPEC% /c dir /w
alias start cmd /c start 
alias kill  taskkill /pid

bindkey CTRL_P vzlike-previous-history
bindkey CTRL_N vzlike-next-history

### Vzライクなキーバインドにする関数
### 利用時には「vzbind」とだけの行を入れてください。
vzbind{
    bindkey CTRL_R xscript:start            xscript:pageup
    bindkey CTRL_S backward                 xscript:backward
    bindkey CTRL_D forward                  xscript:forward
    bindkey CTRL_E vzlike-previous-history  xscript:previous
    bindkey CTRL_X vzlike-next-history      xscript:next
    bindkey CTRL_F forward-word
    bindkey CTRL_A backward-word
}
# vzbind

lua_e "
    --- NYAOS 終了時のフック ---
    function nyaos.goodbye()
        print('Good bye !!')
    end

--    --[[ キーフックサンプル ---
--    function nyaos.keyhook(t)
--        if t.key == nyaos.key.F1 and t.text == '' then
--            return os.getenv('EDITOR') or 'notepad',true
--        end
--        return nil
--    end
--    --]]--
    nyaos.keyhook = nil

    --「%(Lua式)」を処理する Lua コード --
    -- function nyaos.filter(cmdline)
    --     return cmdline:gsub('%%(%b())',function(m)
    --         return loadstring('return '..m)()
    --     end)
    -- end
    function nyaos.filter(cmdline)
        cmdline = cmdline:gsub('^%S+', function(cmd)
            if cmd:match('%.') then
                return false
            end

            local path='.;' .. os.getenv('PATH')

            local cmdl=cmd:lower()
            local variation={}
            for key,val in pairs(nyaos.suffix) do
                variation[ cmdl .. '.' .. key:lower() ] = true
            end

            for path1 in path:gmatch('[^;]+') do
                for fname in nyaos.dir(path1) do
                    if variation[ fname:lower() ] then
                        return fname
                    end
                end
            end
        end)
        return cmdline
    end

    function nyaos.filter2(cmdline)
        cmdline = cmdline:gsub('^%S+', function(cmd)
            if cmd:match('%.') then
                return false
            end

            local path='.;' .. os.getenv('PATH')

            local cmdl=cmd:lower()
            local variation={}
            for ext in os.getenv('PATHEXT'):gmatch('[^;]+') do
                variation[ cmdl .. ext:lower() ] = true
            end

            for path1 in path:gmatch('[^;]+') do
                for fname in nyaos.dir(path1) do
                    if variation[ fname:lower() ] then
                        return fname
                    end
                end
            end
        end)
        return cmdline
    end


    --- which コマンド ---
    function nyaos.command.which(cmd)
        local path='.;' .. os.getenv('PATH')

        --- 引数が無い場合は、PATH の一覧を表示するだけ ---
        if not cmd or cmd:len()==0 then
            for path1 in path:gmatch('[^;]+') do
                print(path1)
            end
            return
        end
        local cmdl=cmd:lower()
        local variation={
            [ cmdl ] = true ,
            [ cmdl .. '.exe' ] = true ,
            [ cmdl .. '.cmd' ] = true ,
            [ cmdl .. '.bat' ] = true ,
            [ cmdl .. '.com' ] = true
        }
        for key,val in nyaos.suffix() do
            variation[ cmdl .. '.' .. key:lower() ] = true
        end

        for path1 in path:gmatch('[^;]+') do
            for fname in nyaos.dir(path1) do
                if variation[ fname:lower() ] then
                    print( path1 .. '\\' .. fname )
                end
            end
        end
    end

    -- 「-t」オプション付きで起動された時：
    for i,e in nyaos.argv() do
        if e == '-t' then
            -- ls にカラーオプションを付ける --
            nyaos.alias.ls = (nyaos.alias.ls or 'ls')..' --color'

            if os.getenv('VIMSHELL') == '1' then
                nyaos.option.ls_colors='fi=37:di=32:sy=31:ro=34:hi=33:ex=35:ec=0'
                nyaos.option.prompt='$e[31m[$w]$_$$ $e[37m'
                nyaos.option.term_clear = ''
            else
                nyaos.option.ls_colors='fi=30:di=32:sy=31:ro=34:hi=33:ex=35:ec=0'
                nyaos.option.prompt='$e[31m[$w]$_$$ $e[30m'
            end
        end
    end

    print('done')
"
